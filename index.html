<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Rowe Casa Organics Email Signature Builder</title>

<style>
  :root{
    --bg:#d7d1ca;
    --card:#ffffff;
    --ink:#25282a;
    --muted:#5f4b3c;
    --line:#d6d1c3;
    --soft:#f6f4f1;

    --danger:#b00020;
    --dangerSoft:#fff0f2;
    --ok:#0a7a2f;
    --warn:#9a5a00;

    --brandRed:#b00020;
    --brandRedHover:#8f001a;

    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }

  body{ margin:16px; background:var(--bg); color:var(--ink); }
  .wrap{ max-width:1100px; margin:0 auto; }

  header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
    margin-bottom:12px;
  }
  .titleRow{ display:flex; align-items:center; gap:12px; flex:1 1 auto; min-width:280px; }
  .titleRow img{ width:34px; height:34px; border-radius:10px; background:var(--card); padding:6px; border:1px solid var(--line); }
  h1{ margin:0; font-size:20px; letter-spacing:.2px; }
  .sub{ margin:6px 0 0; color:#3b3f44; font-size:13px; line-height:1.35; }

  .headerActions{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }

  .helpBtn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid var(--brandRed);
    background:var(--brandRed);
    color:#fff;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
    box-shadow:0 10px 20px rgba(176,0,32,.18);
    transition: all 0.2s ease;
  }
  .helpBtn:hover{ background:var(--brandRedHover); border-color:var(--brandRedHover); }
  .helpBtn:active{ transform:translateY(1px); }
  .helpBtn .dot{
    width:8px; height:8px; border-radius:99px; background:#fff; opacity:.9;
    box-shadow:0 0 0 3px rgba(255,255,255,.18);
  }

  .adminTopBtn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid #bdb4ab;
    background:#fbfaf8;
    color:#1f2326;
    font-weight:900;
    cursor:pointer;
    white-space:nowrap;
  }
  .adminTopBtn:hover{ background:#fff; }
  .adminTopBtn:active{ transform:translateY(1px); }

  .grid{ display:grid; grid-template-columns:420px 1fr; gap:14px; align-items:start; }
  @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }

  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:16px;
    padding:16px;
    box-shadow:0 10px 24px rgba(0,0,0,.06);
  }

  .sectionTitle{ display:flex; align-items:baseline; justify-content:space-between; gap:10px; flex-wrap:wrap; margin:0 0 10px; }
  .sectionTitle h2{ margin:0; font-size:18px; letter-spacing:.2px; }
  .sectionHelp{ margin:0; font-size:13px; color:#51565c; line-height:1.4; }
  .sectionHelp b{ color:#1f2326; }

  .divider{ height:1px; background:var(--line); margin:14px 0; }
  .hint{ margin-top:8px; font-size:12px; color:#51565c; line-height:1.35; }

  label{ display:block; font-size:12px; margin:10px 0 6px; color:#1f2326; }
  .req::after{ content:" *"; color:var(--danger); font-weight:900; }

  input{
    width:100%;
    padding:11px;
    border:1px solid #cfc9c2;
    border-radius:12px;
    font-size:16px;
    box-sizing:border-box;
    background:var(--soft);
    outline:none;
    transition: border-color 0.2s, background 0.2s;
  }
  input:focus{ border-color:#a99f96; box-shadow:0 0 0 3px rgba(95,75,60,.10); background:#fff; }
  input.invalid{ border-color:var(--danger); background:var(--dangerSoft); box-shadow:none; }

  .phoneGroup { display:flex; gap:8px; align-items:stretch; }
  .phoneGroup input:first-child { flex:1; }
  .phoneGroup input:last-child { width:120px; }

  .btnRow{ display:flex; gap:10px; margin-top:14px; flex-wrap:wrap; align-items:center; }
  button{
    padding:10px 14px;
    border-radius:12px;
    border:1px solid #c9c2bb;
    background:#f3f1ee;
    font-weight:900;
    cursor:pointer;
    color:var(--ink);
    transition: all 0.2s ease;
  }
  button.primary{ background:#25282a; color:#fff; border-color:#25282a; }
  button:disabled{ opacity:.55; cursor:not-allowed; }
  button:active{ transform:translateY(1px); }

  @keyframes flashSuccess {
    0% { background-color: var(--ok); border-color: var(--ok); color: white; transform: scale(1.03); }
    100% { transform: scale(1); }
  }
  button.copied { animation: flashSuccess 0.4s ease-out; }

  .status{ margin-top:10px; font-size:12px; line-height:1.35; min-height:34px; }
  .status .ok{ color:var(--ok); font-weight:900; }
  .status .warn{ color:var(--warn); font-weight:900; }
  .status .err{ color:var(--danger); font-weight:900; }

  .callout{
    margin-top:12px;
    padding:12px 14px;
    border-radius:14px;
    border:1px solid rgba(176,0,32,.25);
    background:rgba(176,0,32,.05);
    color:#1f2326;
    font-size:13px;
    line-height:1.35;
  }
  .callout b{ color:var(--danger); }

  /* App selector (checkbox) */
  .appGrid{
    display:grid;
    grid-template-columns:1fr;
    gap:10px;
    margin-top:10px;
  }
  .appOpt{
    display:flex;
    gap:10px;
    align-items:flex-start;
    padding:10px 12px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
    cursor:pointer;
    user-select:none;
  }
  .appOpt:hover{ background:#fbfaf8; }
  .appOpt input{ width:auto; padding:0; margin-top:2px; }
  .appOptTitle{ margin:0; font-weight:900; font-size:13px; color:#1f2326; }
  .appOptDesc{ margin:3px 0 0; font-size:12px; color:#51565c; line-height:1.3; }

  /* Signature preview */
  .previewWrap{
    padding:12px;
    border:1px dashed #bdb4ab;
    border-radius:14px;
    background:#fbfaf8;
    overflow-x:auto;
  }

  /* Instructions cards */
  .instGrid{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    margin-top:12px;
  }
  .instCard{
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    padding:12px;
  }
  .instCard h3{ margin:0 0 6px; font-size:14px; letter-spacing:.2px; }
  .instCard p{ margin:6px 0; font-size:13px; color:#2a2e32; line-height:1.4; }
  .instCard ul{ margin:8px 0 0 18px; padding:0; }
  .instCard li{ margin:6px 0; color:#1f2326; font-size:13px; line-height:1.35; }

  /* Admin panel + accordions */
  .adminNote{
    margin:10px 0 0;
    font-size:12px;
    color:#51565c;
    line-height:1.35;
  }
  .adminPanel{ display:none; margin-top:10px; }
  .adminPanel.show{ display:block; }

  details{
    border:1px solid var(--line);
    background:#fbfaf8;
    border-radius:14px;
    padding:10px 12px;
  }
  summary{
    cursor:pointer;
    font-weight:900;
    color:#1f2326;
    list-style:none;
    outline:none;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
  }
  summary::-webkit-details-marker{ display:none; }
  .accBody{ margin-top:10px; }

  .caret{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:30px;
    height:30px;
    border-radius:10px;
    border:1px solid var(--line);
    background:#fff;
    color:#1f2326;
    font-weight:900;
    line-height:1;
    flex:0 0 auto;
    transform: rotate(180deg);
    transition: transform .18s ease;
  }
  details[open] .caret{ transform: rotate(0deg); }

  textarea{
    width:100%;
    min-height:220px;
    padding:10px;
    border:1px solid #cfc9c2;
    border-radius:12px;
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    font-size:12px;
    box-sizing:border-box;
    background:#fff;
    outline:none;
    white-space:pre;
  }

  /* Help modal */
  .modalBackdrop{
    position:fixed; inset:0;
    background:rgba(37,40,42,.55);
    display:none;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:9999;
    backdrop-filter: blur(2px);
  }
  .modal{
    width:min(920px, 100%);
    background:#fff;
    border-radius:16px;
    border:1px solid var(--line);
    padding:14px;
    box-shadow:0 18px 60px rgba(0,0,0,.22);
  }
  .modal h2{ margin:0 0 10px; font-size:16px; }
  .helpBlock{
    border:1px solid var(--line);
    background:#fbfaf8;
    border-radius:14px;
    padding:12px;
    margin-top:10px;
  }
  .helpBlock h3{ margin:0 0 6px; font-size:13px; letter-spacing:.2px; }
  .helpBlock p{ margin:6px 0; font-size:13px; line-height:1.4; color:#2a2e32; }
  .helpBlock ul{ margin:8px 0 0 18px; padding:0; }
  .helpBlock li{ margin:6px 0; color:#1f2326; font-size:13px; line-height:1.35; }
  .closeRow{
    display:flex;
    justify-content:space-between;
    gap:8px;
    margin-top:12px;
    align-items:center;
    flex-wrap:wrap;
  }
  .kbd{
    font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
    background:#f3f1ee;
    padding:2px 6px;
    border-radius:7px;
    border:1px solid var(--line);
  }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <div class="titleRow">
      <img id="uiLogo" alt="Rowe Casa Organics" />
      <div>
        <h1>Rowe Casa Organics Email Signature Builder</h1>
        <p class="sub">Step 1 → Step 2 → Step 3. Follow only the steps shown for your app.</p>
      </div>
    </div>

    <div class="headerActions">
      <button class="adminTopBtn" id="btnAdminTop" type="button">Admin</button>
      <button class="helpBtn" id="btnHelpTop" type="button" aria-label="Help / How-To">
        <span class="dot"></span>
        Help / How-To
      </button>
    </div>
  </header>

  <div class="grid">
    <!-- STEP 1 (Apps + Details combined) -->
    <section class="card" id="step1">
      <div class="sectionTitle"><h2>Step 1: Select your app(s) + enter details</h2></div>


      <p class="sectionHelp" id="step1statusText">Pick your app, enter your details, then click <b>Build Signature</b>.</p>

      <!-- CHECKBOX: multi-select -->
      <div class="appGrid" role="group" aria-label="Choose your email apps">
        <label class="appOpt">
          <input type="checkbox" name="apps" id="app_gmail_web" value="gmail_web" />
          <div>
            <p class="appOptTitle">Gmail (Web)</p>
            <p class="appOptDesc">Suitable for most people.</p>
          </div>
        </label>

        <label class="appOpt">
          <input type="checkbox" name="apps" id="app_outlook_desktop" value="outlook_desktop" />
          <div>
            <p class="appOptTitle">Outlook (Desktop)</p>
            <p class="appOptDesc">Outlook on Windows or Mac.</p>
          </div>
        </label>

        <label class="appOpt">
          <input type="checkbox" name="apps" id="app_mobile_any" value="mobile_any" />
          <div>
            <p class="appOptTitle">Mobile Apps</p>
            <p class="appOptDesc">Make sure you select your RCO account.</p>
          </div>
        </label>
      </div>

      <div class="divider"></div>

      <p class="sectionHelp">Copy is enabled when everything is valid.</p>

      <label class="req" for="fullName">Full Name</label>
      <input id="fullName" placeholder="First Last" autocomplete="name" />

      <label class="req" for="jobTitle">Job Title</label>
      <input id="jobTitle" placeholder="Job Title" />

      <label class="req" for="email">Work Email</label>
      <input id="email" placeholder="first.last@rowecasaorganics.com" autocomplete="email" inputmode="email" />

      <label for="cell">Cell Phone (optional)</label>
      <input id="cell" placeholder="555-555-5555" inputmode="tel" />

      <label for="phone" style="margin-top:12px;">Office Phone (optional)</label>
      <div class="phoneGroup">
        <input id="phone" placeholder="555-555-5555" inputmode="tel" />
        <input id="ext" placeholder="Ext (1–4)" inputmode="numeric" maxlength="4" />
      </div>

      <div class="btnRow">
        <button id="btnReset" type="button">Reset</button>
        <button id="btnGenerate" class="primary" type="button">Build Signature</button>
      </div>

      <div id="status" class="status"></div>
    </section>

    <!-- RIGHT SIDE: combined Step 2 + 3 -->
    <div class="stack">
      <section class="card" id="step2and3">
        <div class="sectionTitle"><h2>Step 2: Copy + set your signature</h2></div>
        <p class="sectionHelp">
          <b>Copy and paste this</b> into your email app's signature area.
        </p>

        <div class="previewWrap" id="previewArea"></div>

        <div class="btnRow" style="margin-top:12px;">
          <button id="btnCopySignature" class="primary" type="button" disabled>Copy Signature</button>
        </div>

        <div class="callout">
          <b>Important:</b> Do this once for <b>every app / phone you use and test</b>.
        </div>

        <div class="divider"></div>

        <div class="sectionTitle" style="margin-top:0;"><h2>Step 3: Follow the steps for your app(s)</h2></div>
        <p class="sectionHelp"><b>NOTE: Please delete all old signature(s) before proceeding.</b></p>

        <div class="instGrid" id="instWrap"></div>

        <div class="divider"></div>

        <div class="callout">
          <b>Need help?</b> Email IT at:
          <a href="mailto:itsupport@rowecasaorganics.com" style="color:var(--brandRed); font-weight:900; text-decoration:none;">itsupport@rowecasaorganics.com</a>.
          Please be sure to include details and screenshots of your signature settings.
        </div>

        <div class="adminPanel" id="adminPanel">
          <p class="adminNote">Admin options are for special use-cases only (last resort). Most users should only use <b>Copy Signature</b>.</p>

          <div class="divider"></div>

          <details id="plainTextDetails">
            <summary>
              <span>Plain Text (Last resort)</span>
              <span class="caret" aria-hidden="true">^</span>
            </summary>
            <div class="accBody">
              <p class="sectionHelp" style="margin-top:0;">Use only if an app does not allow formatting/images (text-only fields).</p>
              <textarea id="plainOut" spellcheck="false" placeholder="Click Build Signature first to create plain text."></textarea>
              <div class="btnRow" style="margin-top:10px;">
                <button id="btnCopyText" type="button" disabled>Copy Plain Text</button>
              </div>
            </div>
          </details>

          <div class="divider"></div>

          <details id="htmlDetails">
            <summary>
              <span>HTML (Last resort / IT only)</span>
              <span class="caret" aria-hidden="true">^</span>
            </summary>
            <div class="accBody">
              <p class="sectionHelp" style="margin-top:0;">Advanced fallback. Use only when instructed by IT.</p>
              <textarea id="htmlOut" spellcheck="false" placeholder="Click Build Signature first to create HTML."></textarea>
              <div class="btnRow" style="margin-top:10px;">
                <button id="btnCopyHtml" type="button" disabled>Copy HTML</button>
                <button id="btnSave" type="button" disabled>Save to File</button>
              </div>
            </div>
          </details>
        </div>

      </section>
    </div>
  </div>
</div>

<!-- HELP MODAL -->
<div class="modalBackdrop" id="helpBackdrop" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
  <div class="modal">
    <h2 id="helpTitle">Help – Rowe Casa Organics Email Signature</h2>

    <div class="helpBlock">
      <h3>Section 1: The simple rule</h3>
      <p>
        You are setting up the same Rowe Casa Organics signature in every email app you use.
        If you use Gmail + Outlook + a mobile app, you should check and test each one (on each device).
      </p>
    </div>

    <div class="helpBlock">
      <h3>Section 2: What to do on this page</h3>
      <ul>
        <li>Select the app(s) you use in <b>Step 1</b>, and enter your details.</li>
        <li>Click <b>Build Signature</b>.</li>
        <li>Click <b>Copy Signature</b>, paste into your email signature settings, and test.</li>
        <li>Follow the instructions shown for each app you selected.</li>
      </ul>
    </div>

    <div class="helpBlock">
      <h3>Section 3: Need help?</h3>
      <p>
        Email IT at <a href="mailto:itsupport@rowecasaorganics.com">itsupport@rowecasaorganics.com</a>.
        Please include the app, device, and screenshots of your signature settings + what you pasted.
      </p>
    </div>

    <div class="closeRow">
      <div class="hint" style="margin:0;">Press <span class="kbd">Esc</span> to close.</div>
      <button id="btnCloseHelp" type="button">Close</button>
    </div>
  </div>
</div>

<script>
  const BRAND = Object.freeze({
    version: "2025.4",
    approvedDomain: "rowecasaorganics.com",
    logoUrl: "https://www.rowecasaorganics.com/cdn/shop/files/Checkout_Logo.png",
    websiteText: "rowecasaorganics.com",
    websiteUrl: "https://rowecasaorganics.com",
    logoWidthPx: 96,
    leftColPadRightPx: 14,
    dividerPx: 1,
    dividerColor: "#000000",
    rightColPadLeftPx: 14,
    linkColor: "#1155cc"
  });

  const $ = (id) => document.getElementById(id);
  $("uiLogo").src = BRAND.logoUrl;

  function enc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function isValidEmailCommon(v){
    const s = v.trim();
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s);
  }
  function hasApprovedDomain(v){
    const s = v.trim().toLowerCase();
    return s.endsWith("@" + BRAND.approvedDomain);
  }
  function containsLetters(s){ return /[A-Za-z]/.test(s || ""); }

  function groupDigits(digits, groups){
    let out = [];
    let idx = 0;
    for (const g of groups){
      if (idx >= digits.length) break;
      out.push(digits.slice(idx, idx+g));
      idx += g;
    }
    if (idx < digits.length) out.push(digits.slice(idx));
    return out.join(" ");
  }

  function formatPhone(raw){
    const original = (raw || "").trim();
    if (!original) return "";

    const hasPlus = original.startsWith("+");
    const digits = original.replace(/\D+/g, "");
    if (!digits) return original;

    if (hasPlus){
      const ccLen = Math.min(3, Math.max(1, digits.length - 7));
      const cc = digits.slice(0, ccLen);
      const rest = digits.slice(ccLen);
      const restGrouped = groupDigits(rest, [2,3,4,4]);
      return `+${cc} ${restGrouped}`.trim();
    }

    if (digits.length === 10){
      return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
    }
    if (digits.length === 11 && digits.startsWith("1")){
      const d = digits.slice(1);
      return `+1 (${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6)}`;
    }
    if (digits.length === 7){
      return `${digits.slice(0,3)}-${digits.slice(3)}`;
    }
    return groupDigits(digits, [3,3,4,4]);
  }

  function normalizeExt(raw){
    const s = (raw || "").trim();
    if (!s) return "";
    const digitsOnly = s.replace(/\D+/g, "");
    return digitsOnly.slice(0, 4);
  }
  function isValidExt(raw){
    const s = (raw || "").trim();
    if (!s) return true;
    return /^\d{1,4}$/.test(s);
  }

  function getSelectedApps(){
    return Array.from(document.querySelectorAll('input[name="apps"]:checked')).map(x => x.value);
  }

  function getData(){
    return {
      apps: getSelectedApps(),
      fullName: $("fullName").value.trim(),
      jobTitle: $("jobTitle").value.trim(),
      email: $("email").value.trim(),
      cellRaw: $("cell").value,
      officeRaw: $("phone").value,
      extRaw: $("ext").value.trim()
    };
  }

  function validate(d){
    const issues = [];

    if (!d.apps.length){
      issues.push({ field:"apps", msg:"Select at least one email app." });
    }

    if (!d.fullName) issues.push({ field:"fullName", msg:"Full Name is required." });
    if (!d.jobTitle) issues.push({ field:"jobTitle", msg:"Job Title is required." });

    if (!d.email){
      issues.push({ field:"email", msg:"Work Email is required." });
    } else {
      if (!isValidEmailCommon(d.email)){
        issues.push({ field:"email", msg:"Work Email doesn’t look valid." });
      } else if (!hasApprovedDomain(d.email)){
        issues.push({ field:"email", msg:`Email must end with @${BRAND.approvedDomain}.` });
      }
    }

    if (!isValidExt(d.extRaw)){
      issues.push({ field:"ext", msg:"Office extension must be 1–4 digits (numbers only)." });
    }

    if (d.cellRaw && containsLetters(d.cellRaw)){
      issues.push({ field:"cell", msg:"Cell phone must not contain letters." });
    }
    if (d.officeRaw && containsLetters(d.officeRaw)){
      issues.push({ field:"phone", msg:"Office phone must not contain letters." });
    }

    return issues;
  }

  function clearValidationUI(){
    ["fullName","jobTitle","email","cell","phone","ext"].forEach(id => $(id).classList.remove("invalid"));
  }
  function applyValidationUI(issues){
    clearValidationUI();
    const marked = new Set();
    for (const it of issues){
      if (it.field && $(it.field) && !marked.has(it.field)){
        $(it.field).classList.add("invalid");
        marked.add(it.field);
      }
    }
  }

  function setStatus(html){ $("status").innerHTML = html; }

  function buildSignatureHtml(d){
    const cell = formatPhone(d.cellRaw);
    let office = formatPhone(d.officeRaw);
    const ext = normalizeExt(d.extRaw);
    if (office && ext) office += ` x ${ext}`;

    const phoneLines = [];
    if (cell)   phoneLines.push(`<div>C: ${enc(cell)}</div>`);
    if (office) phoneLines.push(`<div>O: ${enc(office)}</div>`);
    const phonesBlock = phoneLines.length ? ("\n        " + phoneLines.join("\n        ") + "\n") : "\n";

    return `<!-- =====================================================
     ROWE CASA ORGANICS EMAIL SIGNATURE
     Version: ${BRAND.version}
     ===================================================== -->
<div>--</div>
<table role="presentation" cellpadding="0" cellspacing="0" border="0" style="border-collapse:collapse; mso-table-lspace:0pt; mso-table-rspace:0pt;">
  <tr>
    <td style="padding:0 ${BRAND.leftColPadRightPx}px 0 0; vertical-align:middle; text-align:center;">
      <img src="${enc(BRAND.logoUrl)}"
           width="${BRAND.logoWidthPx}"
           alt="Rowe Casa Organics"
           style="display:block; margin:0 auto; border:0; outline:none; text-decoration:none;">
    </td>

    <td width="${BRAND.dividerPx}" bgcolor="${BRAND.dividerColor}"
        style="width:${BRAND.dividerPx}px; background-color:${BRAND.dividerColor}; font-size:0; line-height:0;">
      &nbsp;
    </td>

    <td style="padding:0 0 0 ${BRAND.rightColPadLeftPx}px; vertical-align:top;">
      <div style="
        font-family:'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size:11pt;
        line-height:1.25;
        mso-line-height-rule:exactly;
        color:#000000;
      ">
        <div style="font-weight:700;">${enc(d.fullName)}</div>
        <div style="font-weight:400;">${enc(d.jobTitle)}</div>

        <div style="height:8px; line-height:8px; font-size:8px;">&nbsp;</div>

        <div>
          <a href="mailto:${enc(d.email)}" style="color:${BRAND.linkColor}; text-decoration:none;">${enc(d.email)}</a>
        </div>${phonesBlock}
        <div>
          <a href="${enc(BRAND.websiteUrl)}" style="color:${BRAND.linkColor}; text-decoration:none;">${enc(BRAND.websiteText)}</a>
        </div>
      </div>
    </td>
  </tr>
</table>`;
  }

  function buildPlainText(d){
    const cell = formatPhone(d.cellRaw);
    let office = formatPhone(d.officeRaw);
    const ext = normalizeExt(d.extRaw);
    if (office && ext) office += ` x ${ext}`;

    const lines = [];
    lines.push("--");
    lines.push("");
    lines.push(`ROWE CASA ORGANICS | ${d.fullName}`);
    lines.push(`                 | ${d.jobTitle}`);
    lines.push(`                 | ${d.email}`);
    if (cell)   lines.push(`                 | C: ${cell}`);
    if (office) lines.push(`                 | O: ${office}`);
    lines.push(`                 | ${BRAND.websiteText}`);
    return lines.join("\n");
  }

  function stripToText(html){
    const tmp = document.createElement("div");
    tmp.innerHTML = html;
    tmp.querySelectorAll("br").forEach(br => br.replaceWith("\n"));
    tmp.querySelectorAll("div, p, tr, td").forEach(el => {
      if (!el.textContent.endsWith("\n")) el.appendChild(document.createTextNode("\n"));
    });
    return tmp.textContent.replace(/\n{3,}/g, "\n\n").trim();
  }

  function flashBtn(btnId){
    const btn = $(btnId);
    if(!btn) return;
    btn.classList.add("copied");
    const orig = btn.innerText;
    btn.innerText = "Copied!";
    setTimeout(() => {
      btn.classList.remove("copied");
      btn.innerText = orig;
    }, 1100);
  }

  async function copySignatureHtml(html, btnId){
    try{
      if (window.ClipboardItem && navigator.clipboard?.write){
        const htmlBlob = new Blob([html], { type: "text/html" });
        const textBlob = new Blob([stripToText(html)], { type: "text/plain" });
        await navigator.clipboard.write([ new ClipboardItem({ "text/html": htmlBlob, "text/plain": textBlob }) ]);
        flashBtn(btnId);
        return true;
      }
    } catch(_) {}

    try{
      if (navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(stripToText(html));
        flashBtn(btnId);
        return true;
      }
    } catch(_) {}

    return false;
  }

  async function copyTextareaWithFeedback(textareaEl, btnId){
    try{
      if (navigator.clipboard?.writeText){
        await navigator.clipboard.writeText(textareaEl.value);
        flashBtn(btnId);
        return true;
      }
    } catch(_) {}

    textareaEl.focus();
    textareaEl.select();
    textareaEl.setSelectionRange(0, textareaEl.value.length);
    return false;
  }

  function downloadFile(filename, text){
    const blob = new Blob([text], { type: "text/html;charset=utf-8" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 500);
  }

  function ensureInstIntro(){
    const wrap = $("instWrap");
    if (!wrap.innerHTML.trim()){
      wrap.innerHTML = `
        <div class="instCard">
          <h3>Select your app(s) in Step 1</h3>
          <p>Then we’ll show only the instructions you need here.</p>
        </div>
      `;
    }
  }

  function cardGmailWeb(){
    return `
      <div class="instCard" data-app="gmail_web">
        <h3>Gmail (Web)</h3>
        <p>Paste the signature into Gmail in your browser.</p>
        <ul>
          <li>Open Gmail on your computer.</li>
          <li>Settings ⚙️ → <b>See all settings</b> → <b>Signature</b>.</li>
          <li>Create/select your signature, then paste using <b>Copy Signature</b>.</li>
          <li>Set defaults for <b>New emails</b> and <b>Replies/forwards</b> (if available).</li>
          <li>Scroll down and click <b>Save Changes</b>.</li>
          <li>Send yourself a test email to confirm.</li>
        </ul>
      </div>
    `;
  }

  function cardOutlookDesktop(){
    return `
      <div class="instCard" data-app="outlook_desktop">
        <h3>Outlook (Desktop)</h3>
        <p>Paste the signature into Outlook. Divider line may not show in Outlook for Mac — that’s okay.</p>
        <ul>
          <li><b>Recommended:</b> open a <b>New Email</b> window.</li>
          <li>Choose <b>Signature</b> from the ribbon/menu (location varies).</li>
          <li>Paste using <b>Copy Signature</b>.</li>
          <li>Set it as default for <b>New messages</b> and <b>Replies/forwards</b> (if available).</li>
          <li>Send yourself a test email to confirm.</li>
        </ul>
      </div>
    `;
  }

  function cardMobileAny(){
    return `
      <div class="instCard" data-app="mobile_any">
        <h3>Mobile Apps (Gmail or Outlook)</h3>
        <p>Mobile apps vary. Make sure you’re editing your Rowe Casa Organics account settings.</p>
        <ul>
          <li>Open your mail app and confirm you’re on your <b>Rowe Casa Organics</b> account.</li>
          <li>Find Signature settings (usually under Settings).</li>
          <li>Paste the signature.</li>
          <li><b>If it won’t paste nicely:</b> email yourself a test message from your computer (with the signature), then copy it on your phone and paste it into the app settings.</li>
          <li>Send yourself a test email to confirm.</li>
        </ul>
      </div>
    `;
  }

  function renderInstructions(apps){
    const wrap = $("instWrap");
    if (!apps.length){
      wrap.innerHTML = `
        <div class="instCard">
          <h3>Select your app(s) in Step 1</h3>
          <p>Then we’ll show only the instructions you need here.</p>
        </div>
      `;
      return;
    }

    const cards = [];
    if (apps.includes("gmail_web")) cards.push(cardGmailWeb());
    if (apps.includes("outlook_desktop")) cards.push(cardOutlookDesktop());
    if (apps.includes("mobile_any")) cards.push(cardMobileAny());

    wrap.innerHTML = cards.join("");
  }

  function render(showStatus=true){
    $("ext").value = normalizeExt($("ext").value);

    const d = getData();
    renderInstructions(d.apps);

    const issues = validate(d);

    if (issues.length){
      applyValidationUI(issues);
      $("previewArea").innerHTML = `<div class="hint"><span style="color:var(--warn); font-weight:900;">Click Build Signature to create your signature.</span></div>`;
      $("btnCopySignature").disabled = true;

      if ($("btnCopyText")) $("btnCopyText").disabled = true;
      if ($("btnCopyHtml")) $("btnCopyHtml").disabled = true;
      if ($("btnSave")) $("btnSave").disabled = true;

      if ($("htmlOut")) $("htmlOut").value = "";
      if ($("plainOut")) $("plainOut").value = "";

      if (showStatus){
        setStatus(`<span class="err">Fix these items:</span><br>• ${issues.map(x=>x.msg).join("<br>• ")}`);
      }
      return null;
    }

    clearValidationUI();

    const html = buildSignatureHtml(d);
    const txt  = buildPlainText(d);

    $("previewArea").innerHTML = html;
    $("btnCopySignature").disabled = false;

    if ($("htmlOut")) $("htmlOut").value = html;
    if ($("plainOut")) $("plainOut").value = txt;

    if ($("btnCopyText")) $("btnCopyText").disabled = false;
    if ($("btnCopyHtml")) $("btnCopyHtml").disabled = false;
    if ($("btnSave")) $("btnSave").disabled = false;

    if (showStatus){
      setStatus(`<span class="ok">Built.</span> Click <b>Copy Signature</b> then follow the steps below for your selected app(s).`);
    }
    return { html, txt };
  }

  function resetAll(){
    document.querySelectorAll('input[name="apps"]').forEach(r => r.checked = false);
    ["fullName","jobTitle","email","cell","phone","ext"].forEach(id => $(id).value = "");
    clearValidationUI();

    $("previewArea").innerHTML = `<div class="hint">Click <b>Build Signature</b> to create your signature.</div>`;
    $("btnCopySignature").disabled = true;

    if ($("htmlOut")) $("htmlOut").value = "";
    if ($("plainOut")) $("plainOut").value = "";

    if ($("btnCopyText")) $("btnCopyText").disabled = true;
    if ($("btnCopyHtml")) $("btnCopyHtml").disabled = true;
    if ($("btnSave")) $("btnSave").disabled = true;

    renderInstructions([]);
    setStatus(`Choose your app, enter your details, then click <b>Build Signature</b>.`);
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  function openAdmin(){
    const pwd = prompt("Admin password:");
    if (pwd === null) return;
    if (pwd === "password"){
      $("adminPanel").classList.add("show");
      setStatus(`<span class="ok">Admin options unlocked.</span> These are for special use-cases only (last resort).`);
    } else {
      alert("Incorrect password.");
    }
  }

  // Events
  document.querySelectorAll('input[name="apps"]').forEach(r =>
    r.addEventListener("change", () => renderInstructions(getSelectedApps()))
  );

  $("btnReset").addEventListener("click", resetAll);
  $("btnGenerate").addEventListener("click", () => render(true));

  $("btnCopySignature").addEventListener("click", async () => {
    const out = render(false);
    if (!out) return;
    const ok = await copySignatureHtml(out.html, "btnCopySignature");
    setStatus(ok ? `<span class="ok">Copied!</span> Paste into your email signature settings (then test).`
                 : `<span class="warn">Copy may be blocked.</span> Contact IT at itsupport@rowecasaorganics.com with screenshots.`);
  });

  $("btnAdminTop").addEventListener("click", openAdmin);

  document.addEventListener("click", async (e) => {
    if (e.target && e.target.id === "btnCopyText"){
      const out = render(false);
      if (!out) return;
      const ok = await copyTextareaWithFeedback($("plainOut"), "btnCopyText");
      setStatus(ok ? `<span class="ok">Copied!</span> (Plain Text)` : `<span class="warn">Copy may be blocked.</span> The text is selected—copy it manually.`);
    }
    if (e.target && e.target.id === "btnCopyHtml"){
      const out = render(false);
      if (!out) return;
      const ok = await copyTextareaWithFeedback($("htmlOut"), "btnCopyHtml");
      setStatus(ok ? `<span class="ok">Copied!</span> (HTML)` : `<span class="warn">Copy may be blocked.</span> The HTML is selected—copy it manually.`);
    }
    if (e.target && e.target.id === "btnSave"){
      const out = render(false);
      if (!out) return;
      const safeName = ($("fullName").value || "Signature").replace(/[\\/:*?"<>|]+/g, "").trim();
      downloadFile(`Rowe Casa Organics - Signature - ${safeName}.html`, out.html);
      setStatus(`<span class="ok">Saved!</span> File downloaded.`);
    }
  });

  $("cell").addEventListener("blur", () => { $("cell").value = formatPhone($("cell").value); });
  $("phone").addEventListener("blur", () => { $("phone").value = formatPhone($("phone").value); });
  $("ext").addEventListener("blur", () => { $("ext").value = normalizeExt($("ext").value); });

  // Help modal
  const backdrop = $("helpBackdrop");
  function openHelp(){ backdrop.style.display = "flex"; }
  function closeHelp(){ backdrop.style.display = "none"; }
  $("btnHelpTop").addEventListener("click", openHelp);
  $("btnCloseHelp").addEventListener("click", closeHelp);
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeHelp(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeHelp(); });

  // Init
  $("previewArea").innerHTML = `<div class="hint">Click <b>Build Signature</b> to create your signature.</div>`;
  renderInstructions([]);
  setStatus(`Choose your app, enter your details, then click <b>Build Signature</b>.`);
</script>
</body>
</html>